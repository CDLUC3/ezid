name: EZID CI
on: push

jobs:
  tests:
    runs-on: ubuntu-latest

    env:
      IS_CI: 1
      DJANGO_SETTINGS_MODULE: settings.tests
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v1

      - name: Set up pyenv
        run: |
          # Install dependencies
          sudo apt-get update
          sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
            libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \
            libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev \
            liblzma-dev openssl git
  
          # Clone pyenv repository
          curl https://pyenv.run | bash
  
          # Set up environment variables
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> $HOME/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> $HOME/.bashrc
  
          # Add pyenv init to shell
          echo 'eval "$(pyenv init --path)"' >> $HOME/.bashrc
          echo 'eval "$(pyenv init -)"' >> $HOME/.bashrc
  
      - name: Reload shell
        shell: bash
        run: |
          source $HOME/.bashrc

      - name: Install Python with pyenv
        run: |
          pyver=3.11.9
          venv=ezid_${pyver}
          pyenv install ${pyver}
          pyenv activate myenv
          pyenv virtualenv ${pyver} ${venv}
          pyenv activate ${venv}

      - name: Start MySQL service
        run: |
          sudo /etc/init.d/mysql start

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: poetry install

      - name: Dump environment (for troubleshooting)
        run: |
          printf 'PYTHONPATH: %s\n' "$PYTHONPATH"
          # apt-cache pkgnames | sort
          # find / | grep /bin/ | sort
          # pip freeze
          # pip check || true
          python --version
          echo "CWD=${PWD}"
          ls -l
          # mysql -e '
          #  use ezid_test_db;
          #  show tables;
          #  select prefix, minter from ezidapp_shoulder;
          # '

      - name: Prepare DB
        run: |
          mysql -h127.0.0.1 -uroot -proot << EOF
            drop database if exists ezid_test_db;
            create database ezid_test_db;
            use ezid_test_db;
            drop user if exists 'ezid_test_user'@'%';
            create user 'ezid_test_user'@'%' identified by 'ezid_test_pw';
            grant all privileges on ezid_test_db.* to 'ezid_test_user'@'%';
            flush privileges;
          EOF

      - name: Prepare filesystem
        run: |
          mkdir -p ../download/public ../logs

      - name: Setup DB and static files
        run: |
          # ./manage.py makemigrations --merge --no-input
          # ./manage.py makemigrations ezidapp
          python manage.py migrate
          python manage.py collectstatic --no-input

      - name: Load DB fixture
        run: |
          # ./manage.py loaddata --ignorenonexistent db
          python manage.py loaddata db
          #./manage.py diag-update-admin

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest --maxfail 10

#        - pip install -e .
