language:
  python

dist:
  # xenial
  bionic

python:
  - "3.8"

services:
  - mysql

addons:
  apt:
    packages:
      - libdb5.3-dev
env:
  - DJANGO_SETTINGS_MODULE='settings.test_settings'
    IS_TRAVIS=1
#virtualenv:
#  system_site_packages: true

install:
  - pip install --upgrade pip setuptools wheel

before_script:
  - mysql -e "
      create database if not exists ezid_test_db;
      use ezid_test_db;
      create user 'ezid_test_user'@'%' identified by '';
      grant all privileges on *.* to 'ezid_test_user'@'%';
      flush privileges;
    "

  - ls -l
  - pip install -r ./requirements.txt
  - python --version
  - pip freeze
  - pip check || true
  - ls -la ${HOME}
  - ls -la ${TRAVIS_BUILD_DIR}
  - echo "CWD=${PWD}"

script:
  - mkdir -p ../download/public ../logs
  - python ${TRAVIS_BUILD_DIR}/manage.py makemigrations --merge --no-input
  - python ${TRAVIS_BUILD_DIR}/manage.py migrate
  - python ${TRAVIS_BUILD_DIR}/manage.py collectstatic --no-input

  - python ${TRAVIS_BUILD_DIR}/manage.py loaddata --ignorenonexistent store-test
  - python ${TRAVIS_BUILD_DIR}/manage.py loaddata --ignorenonexistent search-init
  - python ${TRAVIS_BUILD_DIR}/manage.py loaddata --ignorenonexistent combined-limited
  
  - python ${TRAVIS_BUILD_DIR}/manage.py diag-update-admin

  - mysql -e "
      use ezid_test_db;
      show tables;
      select prefix, minter from ezidapp_shoulder;
  "

  - pip install -e .
  - pytest


