{% load layout_extras %}
{% load i18n %}
<script type="text/javascript" src="/static/javascripts/rng_to_html/extras.js"></script>
<script type="text/javascript" src="/static/javascripts/rng_to_html/form_initialization.js"></script>
<script type="text/javascript" src="/static/javascripts/rng_to_html/formFunctions.js"></script>
<script type="text/javascript" src="/static/javascripts/rng_to_html/dom_utils.js"></script>

<link type="text/css" rel="stylesheet" href="/static/stylesheets/datacite_xml.css"/>
<br/>
<div name="/resource" class="element">

<!-- Old format: -->
<!-- datacite_get_creators datacite_obj datacite_obj_empty --> 
{{ form.creator_set.management_form }}
<div name="creators-" class="element datacite-container">
  <label for="creators-" class="element"><span title="Creator is a required section">{% trans "Creator" %}</span> <span class="required">*</span></label>
  <input type="button" value="+" onclick="addOne(this)" name="creators" nbelmtsadded="1" class="addButton">
  <input type="button" value="-" name="creators-" class="rmvButton">

  <div class="multiple">
{% for form in form.creator_set %}
  {% for field in form %}
    <div name="creators-[1]" class="element row{% if field.errors %} has-error{% endif %}">
      <div name="{{ field.id_for_label }}" class="element form-group form-group-sm">
        <label for="{{ field.id_for_label }}" class="element col-sm-3 control-label"><span>{{ field.label }}</span>
        {% if forloop.first %}
        <span class="required">*</span>
        {% endif %}
        </label>
        <div class="element col-sm-5">
          {{ field|add_attributes:"data form-control"}}
        </div>
      {% if field.errors %}
        <div class="element col-sm-2">
        {% for error in field.errors %}
          {{ error|escape }}
        {% endfor %}
        </div>
      {% endif %}
      </div>
    </div>
  {% endfor %}
{% endfor %}
  </div>
</div>


{{ form.title_set.management_form }}
<div name="titles-" class="element datacite-container">
  <label for="titles-" class="element"><span title="Title is a required section">{% trans "Title" %}</span> <span class="required">*</span></label>
  <input type="button" value="+" onclick="addOne(this)" name="titles" nbelmtsadded="1" class="addButton">
  <input type="button" value="-" name="titles-" class="rmvButton">

  <div class="multiple">
{% for form in form.title_set %}
    <!-- form.title -->
    <div name="titles-[1]" class="element row{% if form.title.errors %} has-error{% endif %}">
      <div name="{{ form.title.id_for_label }}" class="element form-group form-group-sm">
        <label for="{{ form.title.id_for_label }}" class="element col-sm-3 control-label">
          <span>{{ form.title.label }}</span>
            {% if forloop.first %}
            <span class="required">*</span>
            {% endif %}
        </label>
        <div class="element col-sm-5">
          {{ form.title|add_attributes:"data form-control"}}
        </div>
      {% if form.title.errors %}
        <div class="element col-sm-2">
        {% for error in form.title.errors %}
          {{ error|escape }}
        {% endfor %}
        </div>
      {% endif %}
      </div>
    </div>
    <!-- form.titleType -->
    <div name="titles-[1]" class="attribute row{% if form.titleType.errors %} has-error{% endif %}">
      <div name="{{ form.titleType.id_for_label }}" class="element form-group form-group-sm">
        <label for="{{ form.titleType.id_for_label }}" class="element col-sm-3 control-label">
          {{ form.titleType.label }}
        </label>
        <div class="attribute col-sm-7">
          <label class="radio-css" for="id_titles-0-titleType_0">
          {{ form.titleType.0.tag }}<span>{{ form.titleType.0.choice_label }}</span></label>
          <label class="radio-css" for="id_titles-0-titleType_1">
          {{ form.titleType.1.tag }}<span>{{ form.titleType.1.choice_label }}</span></label>
          <label class="radio-css" for="id_titles-0-titleType_2">
          {{ form.titleType.2.tag }}<span>{{ form.titleType.2.choice_label }}</span></label>
          <label class="radio-css" for="id_titles-0-titleType_3">
          {{ form.titleType.3.tag }}<span>{{ form.titleType.3.choice_label }}</span></label>
        </div>
      </div>
    </div>
{% endfor %}
  </div>
</div>
</div>

<label class="element sized">&nbsp;</label><div><span class="required">*</span> {% trans "required item" %}</div>

<script type="text/javascript">
  $(document).ready(function() {
    /* change the behavior when adding a section to erase contents of new text boxes
     * which the obfuscated javascript form the external library uses.
     */
    $('input[type=button].addButton').click(function (e)
    {
      if(!e.isDefaultPrevented())
      {
        var items = $(e.target).parent().children('div.multiple').children('div.element').last().find('input[type=text].data');
        items.each(function() {
          var $this = $(this);
          $this[0].value = '';
        })
        items = $(e.target).parent().children('div.multiple').children('div.element').last().find('select');
        items.each(function() {
          $(this).prop('selectedIndex', 0);
        })
        items = $(e.target).parent().children('div.multiple').children('div.element').last().find('input[type=radio]');
        if(items.length > 0)
          items[0].checked = true;
      }
    });
		
    //* set the resourceType to the same as resourceTypeGeneral
    $(':submit').click(function(e)
    {
      var gen = $('#resource_type_general').val();
      var res_type = $('#resource_type').val();			
      if(gen != '' && res_type == ''){
        $('#resource_type').val(gen);
      }
    });
  });


  $('input[type=button].rmvButton').click(function (e)  {
  /* Confirmation step before user removes an element */
    var continue_removal = confirm ("Please confirm you want to remove last item.");
    if (continue_removal) { 
      var addButton = getPreviousSiblingElement(e.target, "input");
      var nbElementsAdded = parseInt(addButton.getAttribute("nbelmtsadded"));
      // The element to remove is the last <div class="multiple"> brother element of the removeButton
      var parentNode = e.target.parentNode;
      var divTag = getLastChildElementByTagAndAtt(parentNode, "div", "class", "multiple");
      /* If only one element remains, then set element's items to empty 
       * This differs from external javascript library, which only hides
       * the element.                                        */
      if (nbElementsAdded == 1) {
        var items = $(divTag).find('input[type=text].data');
        items.each(function() {
          var $this = $(this);
          $this[0].value = '';
        })
        items = $(divTag).find('select');
        items.each(function() {
          $(this).prop('selectedIndex', 0);
        })
        items = $(divTag).find('input[type=radio]');
        if(items.length > 0)
          items[0].checked = true;
        } else {
          removeOne(e.target); 
        }
      }
    });
</script>
